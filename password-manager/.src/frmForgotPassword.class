' Gambas class file

Public Sub Form_Open()

  ModDB.Connect()

End

Public Sub btnVerifyEmail_Click()

  Dim res As Result

  If txtRecoveryEmail.Text = "" Then
    Message.Error("Please enter your recovery email.", "Try again")
    txtRecoveryEmail.SetFocus()
    Return 
  Endif
  
  res = ModDB.$Con.Find("login", "email = &1", txtRecoveryEmail.Text)
  If res.Available Then 
    Message.Info("Recovery email found!", "Continue")
    txtRecoveryEmail.Enabled = False
    btnVerifyEmail.Enabled = False
    txtRecoveryEmail.Background = Color.SelectedBackground
    txtRecoveryEmail.Foreground = Color.TextBackground
    
    ' this will enable the security question and answer
    txtSecurityQuestion.Text = res!"security_question" ' this will show the security question of the user
    txtRecoveryAnswer.Enabled = True
    btnVerifyAnswer.Enabled = True
    txtRecoveryAnswer.SetFocus()
    
  Else 
    Message.Error("Recovery email does not exist.", "Try again")
    txtRecoveryEmail.Clear()
    txtRecoveryEmail.SetFocus()
  Endif
End

Public Sub btnVerifyAnswer_Click()

  Dim res As Result

  If txtRecoveryAnswer.Text = "" Then
    Message.Error("Please enter your recovery answer.", "Try again")
    txtRecoveryAnswer.SetFocus()
    Return 
  Endif
  
  res = ModDB.$Con.Find("login", "email = &1 AND security_answer = &2", txtRecoveryEmail.Text, txtRecoveryAnswer.Text)
  If res.Available Then 
    lblFoundAccountMsg.Text = "We found your account!"
    txtRecoveredUsername.Text = res!"username" ' this will show the username of the user
    txtRecoveryAnswer.Enabled = False
    btnVerifyAnswer.Enabled = False
    txtRecoveryAnswer.Background = Color.SelectedBackground
    txtRecoveryAnswer.Foreground = Color.TextBackground
    
    ' this will enable the new password text and reset password button
    txtNewPassword.Enabled = True
    btnResetPassword.Enabled = True
    
  Else 
    Message.Error("Recovery answer is incorrect.", "Try again")
    txtRecoveryAnswer.Clear()
    txtRecoveryAnswer.SetFocus()
  Endif

End

Public Sub btnResetPassword_Click()

  Dim res As Result
  
  res = ModDB.$Con.Edit("login", "username = &1 AND email = &2 AND security_answer = &3", txtRecoveredUsername.Text, txtRecoveryEmail.Text, txtRecoveryAnswer.Text)
  
  If res.Available Then 
    res!password = txtNewPassword.Text
    res.Update()
    Message.Info("Password successfully reset!", "OK")
    Me.Close()
    frmLogin.Show()
    Return 
  Endif

End

Public Sub Form_Close()

  frmLogin.Show()
  
End
